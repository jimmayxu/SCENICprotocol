#!/bin/bash

#######################################################################
#                  submit job for run_scenic.sh                    #
#######################################################################


#./cluster_submission/submit_scenic.sh 'voigt19' 'voigt19.processed.loom'
#./cluster_submission/submit_scenic.sh 'menon19' 'menon19.processed.loom'
#./cluster_submission/submit_scenic.sh 'lukowski19' 'lukowski19.processed.loom'
#./cluster_submission/submit_scenic.sh 'vento18_10x' 'vento18_10x.processed.loom'
#./cluster_submission/submit_scenic.sh 'vento18_ss2' 'vento18_ss2.processed.loom'
#./cluster_submission/submit_scenic.sh 'wang20_colon' 'wang20_colon.processed.loom'
#./cluster_submission/submit_scenic.sh 'martin19' 'martin19.processed.loom'
#./cluster_submission/submit_scenic.sh 'wang20_ileum' 'wang20_ileum.processed.loom'
#./cluster_submission/submit_scenic.sh 'wang20_rectum' 'wang20_rectum.processed.loom'
#./cluster_submission/submit_scenic.sh 'madissoon20_spleen' 'madissoon20_spleen.processed.loom'
#./cluster_submission/submit_scenic.sh 'madissoon20_oesophagus' 'madissoon20_oesophagus.processed.loom'


#./cluster_submission/submit_scenic.sh 'vas13_aerocytes' 'vas13_aerocytes.loom'
#./cluster_submission/submit_scenic.sh 'vas13_artery' 'vas13_artery.loom'
#./cluster_submission/submit_scenic.sh 'vas13_capillary' 'vas13_capillary.loom'
#./cluster_submission/submit_scenic.sh 'vas13_capillary-immune' 'vas13_capillary-immune.loom'
#./cluster_submission/submit_scenic.sh 'vas13_endocardium' 'vas13_endocardium.loom'
#./cluster_submission/submit_scenic.sh 'vas13_lymphatic-ec' 'vas13_lymphatic-ec.loom'
#./cluster_submission/submit_scenic.sh 'vas13_mito' 'vas13_mito.loom'
#./cluster_submission/submit_scenic.sh 'vas13_pericyte-1' 'vas13_pericyte-1.loom'
#./cluster_submission/submit_scenic.sh 'vas13_pericyte-2' 'vas13_pericyte-2.loom'
#./cluster_submission/submit_scenic.sh 'vas13_ribo' 'vas13_ribo.loom'
#./cluster_submission/submit_scenic.sh 'vas13_smc-1' 'vas13_smc-1.loom'
#./cluster_submission/submit_scenic.sh 'vas13_smc-2' 'vas13_smc-2.loom'
#./cluster_submission/submit_scenic.sh 'vas13_vein' 'vas13_vein.loom'

#./cluster_submission/submit_scenic.sh 'vas13capillary_0' 'vas13capillary_0.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary_1' 'vas13capillary_1.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary_2' 'vas13capillary_2.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary_3' 'vas13capillary_3.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary_4' 'vas13capillary_4.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary_5' 'vas13capillary_5.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary_6' 'vas13capillary_6.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary_7' 'vas13capillary_7.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary_8' 'vas13capillary_8.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary_9' 'vas13capillary_9.loom'

#./cluster_submission/submit_scenic.sh 'vas13capillary0' 'vas13capillary.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary1' 'vas13capillary.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary2' 'vas13capillary.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary3' 'vas13capillary.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary4' 'vas13capillary.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary5' 'vas13capillary.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary6' 'vas13capillary.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary7' 'vas13capillary.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary8' 'vas13capillary.loom'
#./cluster_submission/submit_scenic.sh 'vas13capillary9' 'vas13capillary.loom'

#./cluster_submission/submit_scenic.sh 'PanFetalImmune_YS' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_YS.loom'
#./cluster_submission/submit_scenic.sh 'PanFetalImmune_TH-2' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_TH.loom'
#./cluster_submission/submit_scenic.sh 'PanFetalImmune_SP-2' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_SP.loom'
#./cluster_submission/submit_scenic.sh 'PanFetalImmune_SK' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_SK.loom'
#./cluster_submission/submit_scenic.sh 'PanFetalImmune_MLN' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_MLN.loom'
#./cluster_submission/submit_scenic.sh 'PanFetalImmune_LI' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_LI.loom'
#./cluster_submission/submit_scenic.sh 'PanFetalImmune_KI' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_KI.loom'
#./cluster_submission/submit_scenic.sh 'PanFetalImmune_GU' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_GU.loom'
#./cluster_submission/submit_scenic.sh 'PanFetalImmune_BM' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_BM.loom'



#./cluster_submission/submit_scenic.sh 'PanFetalImmune_T_cells-2' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_T_cells.loom'
#./cluster_submission/submit_scenic.sh 'PanFetalImmune_B_cells-2' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_B_cells.loom'

#./cluster_submission/submit_scenic.sh 'PanFetalImmune_SUBT_cells-2' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_SUBT_cells.loom'
#./cluster_submission/submit_scenic.sh 'PanFetalImmune_SUBB_cells-2' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_SUBB_cells.loom'
#./cluster_submission/submit_scenic.sh 'PanFetalImmune_SUBTH-2' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_SUBTH.loom'
#./cluster_submission/submit_scenic.sh 'PanFetalImmune_SUBSP-2' 'PAN.A01.v01.raw_count.20210429.PFI.embedding_SUBSP.loom'

#./cluster_submission/submit_scenic.sh 'PanFetalImmune' 'PAN.A01.v01.raw_count.20210429.PFI.embedding.loom'

#./cluster_submission/submit_scenic.sh 'PanFetalImmune100' 'PAN.A01.v01.raw_count.20210429.PFI.embedding.loom' 'Pan_fetal_immune/marker_gene_HVG.csv'

#./cluster_submission/submit_scenic.sh 'Vasculature100' 'adult13_vas_20211026.loom' 'Vasculature/marker_gene_VAS.csv'

#./cluster_submission/submit_scenic.sh 'Fetal_thymus100' 'covid19cellatlas.Fetal_thymus.loom' 'Fetal_thymus/marker_gene_HVG.csv'
#./cluster_submission/submit_scenic.sh 'Fetal_lung100' 'covid19cellatlas.Fetal_lung.loom' 'Fetal_lung/marker_gene_HVG.csv'
#./cluster_submission/submit_scenic.sh 'Fetal_liver100' 'covid19cellatlas.Fetal_liver.loom' 'Fetal_liver/marker_gene_HVG.csv'

#./cluster_submission/submit_scenic.sh 'Flung1' 'covid19cellatlas.Fetal_lung.loom' 'Fetal_lung/marker_gene_HVG.csv'
#./cluster_submission/submit_scenic.sh 'Flung2' 'covid19cellatlas.Fetal_lung.loom' 'Fetal_lung/marker_gene_HVG.csv'
#./cluster_submission/submit_scenic.sh 'Flung3' 'covid19cellatlas.Fetal_lung.loom' 'Fetal_lung/marker_gene_HVG.csv'


#./cluster_submission/submit_scenic.sh 'Fetal_lung500' 'covid19cellatlas.Fetal_lung.loom' 'Fetal_lung/marker_gene_HVG500.csv'
#./cluster_submission/submit_scenic.sh 'Fetal_lung1000' 'covid19cellatlas.Fetal_lung.loom' 'Fetal_lung/marker_gene_HVG1000.csv'
#./cluster_submission/submit_scenic.sh 'Fetal_lung5000' 'covid19cellatlas.Fetal_lung.loom' 'Fetal_lung/marker_gene_HVG50000.csv'
#./cluster_submission/submit_scenic.sh 'Fetal_lung10000' 'covid19cellatlas.Fetal_lung.loom' 'Fetal_lung/marker_gene_HVG10000.csv'

# ID of run instance (e.g. loop over to submit several jobs)
runID="$1"
LOOM="$2"
TG_path="$3"
# queue="long"
queue="parallel"
OUTDIR="HCA_analysis/scenic_$runID"
# prepare output folder
mkdir -p "$OUTDIR/FarmOut"
mkdir -p "HCA_analysis/grnboost_$runID/FarmOut"
mkdir -p "HCA_analysis/cisTopic_$runID/FarmOut"
mkdir -p "HCA_analysis/AUCell_$runID/FarmOut"
rm -f \
	"$OUTDIR/FarmOut/stderr.log" \
	"$OUTDIR/FarmOut/stdout.log"

# submit job
echo "submitting job for $runID..."


MEM=680000
CORES=60
bsub \
	-q "$queue" \
	-J"scenic_Job$runID" \
	-e "$OUTDIR/FarmOut/stderr.log" \
	-o "$OUTDIR/FarmOut/stdout.log" \
	-n "$CORES" \
	-M"$MEM" \
	-R"select[mem>$MEM] rusage[mem=$MEM] span[hosts=1]" \
	"bash ./cluster_submission/run_scenic.sh $runID $CORES $LOOM $TG_path 1>&2"

# watch
echo "PEND ...waiting for job to start"
while [ -n "$(bjobs -w | grep $runID | grep PEND)" ]
do
	sleep 10s
done
if [ -n "$(bjobs -w | grep $runID | grep RUN)" ]
then
	echo "RUN ...showing stderr:"
	tail -f "$OUTDIR/FarmOut/stderr.log"
else
	echo "terminated ...showing stdout:"
	tail -f "$OUTDIR/FarmOut/stdout.log"
fi


